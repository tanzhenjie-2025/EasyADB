{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            padding: 20px;
            background-color: #f5f7fa;
            font-family: "Microsoft YaHei", sans-serif;
        }
        .header {
            margin-bottom: 20px;
        }
        .header h1 {
            color: #303133;
            font-size: 24px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            margin: 0 4px;
        }
        .btn-default {
            background-color: #f5f7fa;
            color: #606266;
        }
        .btn-default:hover {
            background-color: #e5e6eb;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .info-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .info-item {
            flex: 1;
            min-width: 200px;
        }
        .info-item label {
            font-weight: 500;
            color: #606266;
            display: block;
            margin-bottom: 4px;
        }
        .info-item span {
            color: #303133;
        }
        .status-running {
            color: #409eff;
        }
        .status-success {
            color: #67c23a;
        }
        .status-failed, .status-error {
            color: #f56c6c;
        }
        .status-timeout {
            color: #e6a23c;
        }
        .log-content {
            margin-top: 20px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
        }
        .log-tab {
            display: flex;
            border-bottom: 1px solid #dcdfe6;
        }
        .log-tab-item {
            padding: 8px 16px;
            cursor: pointer;
            border-right: 1px solid #dcdfe6;
            background-color: #f8f9fa;
        }
        .log-tab-item.active {
            background-color: #409eff;
            color: #fff;
        }
        .log-tab-content {
            padding: 16px;
            height: 300px;
            overflow-y: auto;
            font-family: Consolas, monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .log-tab-content:empty {
            text-align: center;
            color: #909399;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ page_title }}</h1>
        <div>
            <a href="{% url 'script_center:execute_task' %}" class="btn btn-default">ğŸ”™ è¿”å›æ‰§è¡Œé¡µé¢</a>
        </div>
    </div>

    <div class="card">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="info-row">
            <div class="info-item">
                <label>ä»»åŠ¡åç§°</label>
                <span>{{ log.task.task_name }}</span>
            </div>
            <div class="info-item">
                <label>æ‰§è¡Œè®¾å¤‡</label>
                <span>{{ log.device.device_name }} ({{ log.device.adb_connect_str }})</span>
            </div>
            <div class="info-item">
                <label>æ‰§è¡ŒçŠ¶æ€</label>
                <span>
                    {% if log.exec_status == 'running' %}
                        <span class="status-running">ğŸ”„ æ‰§è¡Œä¸­</span>
                    {% elif log.exec_status == 'success' %}
                        <span class="status-success">âœ… æ‰§è¡ŒæˆåŠŸ</span>
                    {% elif log.exec_status == 'failed' %}
                        <span class="status-failed">âŒ æ‰§è¡Œå¤±è´¥</span>
                    {% elif log.exec_status == 'timeout' %}
                        <span class="status-timeout">â° æ‰§è¡Œè¶…æ—¶</span>
                    {% else %}
                        <span class="status-error">ğŸ’¥ æ‰§è¡Œå¼‚å¸¸</span>
                    {% endif %}
                </span>
            </div>
        </div>

        <div class="info-row">
            <div class="info-item">
                <label>å¼€å§‹æ—¶é—´</label>
                <span>{{ log.start_time|date:"Y-m-d H:i:s" }}</span>
            </div>
            <div class="info-item">
                <label>ç»“æŸæ—¶é—´</label>
                <span>{{ log.end_time|date:"Y-m-d H:i:s"|default:"æ‰§è¡Œä¸­..." }}</span>
            </div>
            <div class="info-item">
                <label>æ‰§è¡Œè€—æ—¶</label>
                <span>{{ log.exec_duration|default:"-" }} ç§’</span>
            </div>
        </div>

        <div class="info-item">
            <label>æ‰§è¡Œå‘½ä»¤</label>
            <span style="word-break: break-all;">{{ log.exec_command|default:"-" }}</span>
        </div>

        <!-- æ—¥å¿—å†…å®¹ -->
        <div class="log-content">
            <div class="log-tab">
                <div class="log-tab-item active" onclick="showLog('stdout')">æ ‡å‡†è¾“å‡º</div>
                <div class="log-tab-item" onclick="showLog('stderr')">é”™è¯¯è¾“å‡º</div>
            </div>
            <div id="stdout-content" class="log-tab-content">
                {{ log.stdout|default:"æš‚æ— è¾“å‡º" }}
            </div>
            <div id="stderr-content" class="log-tab-content" style="display: none;">
                {{ log.stderr|default:"æš‚æ— é”™è¯¯è¾“å‡º" }}
            </div>
        </div>
    </div>

    <script>
        // åˆ‡æ¢æ—¥å¿—æ ‡ç­¾ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
        function showLog(type) {
            document.querySelectorAll('.log-tab-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            document.getElementById('stdout-content').style.display = type === 'stdout' ? 'block' : 'none';
            document.getElementById('stderr-content').style.display = type === 'stderr' ? 'block' : 'none';
        }

        // è½®è¯¢åˆ·æ–°æ—¥å¿—ï¼ˆå…œåº•å‡½æ•°ï¼‰
        function startPolling(logId) {
            // æ¯5ç§’è½®è¯¢ä¸€æ¬¡ï¼Œä¸åŸé€»è¾‘ä¸€è‡´
            const pollInterval = setInterval(() => {
                fetch(`{% url 'script_center:log_status' 0 %}`.replace('0', logId))
                    .then(response => {
                        if (!response.ok) throw new Error('è½®è¯¢æ¥å£å¼‚å¸¸');
                        return response.json();
                    })
                    .then(data => {
                        if (data.code === 200) {
                            document.getElementById('stdout-content').textContent = data.stdout || "æš‚æ— è¾“å‡º";
                            document.getElementById('stderr-content').textContent = data.stderr || "æš‚æ— é”™è¯¯è¾“å‡º";
                            // ä»»åŠ¡ç»“æŸååœæ­¢è½®è¯¢
                            if (data.status !== "running") {
                                clearInterval(pollInterval);
                                location.reload();
                            }
                        }
                    })
                    .catch(err => {
                        console.warn('è½®è¯¢å¤±è´¥:', err);
                    });
            }, 5000);
            return pollInterval;
        }

        // WebSocket + è½®è¯¢é™çº§ä¸»é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            const logId = "{{ log.id }}";
            const status = "{{ log.exec_status }}";

            if (status === "running") {
                let pollInterval = null; // è½®è¯¢å®šæ—¶å™¨

                // ä¼˜å…ˆå°è¯• WebSocket è¿æ¥
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws/script_log/${logId}/`;
                const socket = new WebSocket(wsUrl);

                // WebSocket è¿æ¥æˆåŠŸï¼šç¦ç”¨è½®è¯¢
                socket.onopen = function(e) {
                    console.log(`[è„šæœ¬æ—¥å¿—-${logId}] WebSocketè¿æ¥å·²å»ºç«‹`);
                    if (pollInterval) clearInterval(pollInterval);
                };

                // WebSocket æ¥æ”¶æ¶ˆæ¯ï¼šå®æ—¶æ›´æ–°æ—¥å¿—
                socket.onmessage = function(e) {
                    const response = JSON.parse(e.data);
                    if (response.type === 'log_update') {
                        const data = response.data;
                        document.getElementById('stdout-content').textContent = data.stdout || "æš‚æ— è¾“å‡º";
                        document.getElementById('stderr-content').textContent = data.stderr || "æš‚æ— é”™è¯¯è¾“å‡º";
                        if (data.status !== "running") {
                            socket.close();
                            setTimeout(() => location.reload(), 1000);
                        }
                    }
                };

                // WebSocket å¤±è´¥/å…³é—­ï¼šå¯åŠ¨è½®è¯¢é™çº§
                socket.onerror = function(error) {
                    console.error(`[è„šæœ¬æ—¥å¿—-${logId}] WebSocketè¿æ¥å¤±è´¥ï¼Œå¯åŠ¨è½®è¯¢é™çº§`, error);
                    if (!pollInterval) pollInterval = startPolling(logId);
                };
                socket.onclose = function(e) {
                    // ä»…åœ¨ä»»åŠ¡è¿è¡Œä¸­ä¸”éä¸»åŠ¨å…³é—­æ—¶å¯åŠ¨è½®è¯¢
                    if (status === "running" && e.code !== 1000) {
                        console.warn(`[è„šæœ¬æ—¥å¿—-${logId}] WebSocketè¿æ¥å…³é—­ï¼Œå¯åŠ¨è½®è¯¢é™çº§`, e.code);
                        if (!pollInterval) pollInterval = startPolling(logId);
                    }
                };

                // åˆå§‹å¯åŠ¨è½®è¯¢ï¼ˆWebSocket è¿æ¥æˆåŠŸåä¼šè‡ªåŠ¨åœæ­¢ï¼‰
                pollInterval = startPolling(logId);
            }
        });
    </script>
</body>
</html>