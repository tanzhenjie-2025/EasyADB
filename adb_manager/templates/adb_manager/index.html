{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
    .status-online { color: #67c23a; font-weight: 500; }
    .status-offline { color: #f56c6c; }
    .status-error { color: #e6a23c; }
    .action-btn {
        padding: 4px 8px;
        font-size: 12px;
        margin-right: 5px;
    }
    .serial-column {
        max-width: 200px;
        word-break: break-all;
    }
    .device-table tr:hover {
        background-color: #f8f9fa;
    }
    .empty-device-cell {
        text-align: center;
        padding: 30px !important;
    }

    /* åŸæœ‰æ¨¡æ€æ¡†æ ·å¼ä¿æŒä¸å˜ */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background-color: #fff;
        width: 80%;
        max-width: 1000px;
        border-radius: 8px;
        padding: 20px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #1989fa;
    }
    .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
    }
    .close-modal:hover {
        color: #333;
    }
    .device-list-item {
        padding: 8px 0;
        border-bottom: 1px dashed #eee;
    }
    .device-list-item:last-child {
        border-bottom: none;
    }
    .device-serial {
        font-weight: 500;
        color: #1989fa;
    }
    .raw-output {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 14px;
        margin-top: 15px;
        white-space: pre-wrap;
    }

    /* æ–°å¢ï¼šè®¾å¤‡è¯¦æƒ…æ ·å¼ */
    .detail-item {
        display: flex;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px dashed #eee;
    }
    .detail-label {
        width: 120px;
        font-weight: 600;
        color: #666;
    }
    .detail-value {
        flex: 1;
        color: #333;
    }
    .detail-section {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
    .detail-section:last-child {
        border-bottom: none;
    }
    .detail-section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
        color: #1989fa;
    }

    /* åœ¨åŸæœ‰æ ·å¼åŸºç¡€ä¸Šæ·»åŠ  */
    .btn-purple {
        background-color: #9b59b6;
        color: white;
        border: none;
    }

    .btn-purple:hover {
        background-color: #8e44ad;
    }

    /* æ–°å¢ï¼šæ—¥å¿—æ¨¡æ€æ¡†è¡¥å……æ ·å¼ */
    .form-control {
        padding: 6px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }
    .btn-default {
        background-color: #fff;
        color: #333;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
    }
    .btn-default:hover {
        background-color: #e6e6e6;
    }
    .table {
        width: 100%;
        margin-bottom: 1rem;
        color: #212529;
        border-collapse: collapse;
    }
    .table th, .table td {
        padding: 0.75rem;
        vertical-align: top;
        border-top: 1px solid #dee2e6;
    }
    .table thead th {
        vertical-align: bottom;
        border-bottom: 2px solid #dee2e6;
    }
    .logs-filter {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
</style>
{% endblock %}

{% block page_header %}
<div class="page-header">
    <h1>ğŸ“± {{ page_title }}</h1>
    <div class="btn-group">
        <a href="{% url 'adb_manager:add_device' %}" class="btn btn-primary">æ·»åŠ è®¾å¤‡</a>
        <form method="POST" action="{% url 'adb_manager:connect_all' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">ä¸€é”®è¿æ¥æ‰€æœ‰</button>
        </form>
        <form method="POST" action="{% url 'adb_manager:disconnect_all' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">ä¸€é”®æ–­å¼€æ‰€æœ‰</button>
        </form>
        <form method="POST" action="{% url 'adb_manager:refresh_all' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-warning">åˆ·æ–°æ‰€æœ‰çŠ¶æ€</button>
        </form>
        <!-- åŸæœ‰ï¼šæŸ¥çœ‹å·²è¿æ¥è®¾å¤‡æŒ‰é’® -->
        <button id="listDevicesBtn" class="btn btn-info">æŸ¥çœ‹å·²è¿æ¥è®¾å¤‡</button>
        <!-- æ–°å¢ï¼šæŸ¥çœ‹æ“ä½œæ—¥å¿—æŒ‰é’® -->
        <button id="viewLogsBtn" class="btn btn-secondary">æŸ¥çœ‹æ“ä½œæ—¥å¿—</button>
    </div>
</div>
{% endblock %}

{% block content %}
    <!-- åŸæœ‰æç¤ºä¿¡æ¯ä¿æŒä¸å˜ -->
    {% if request.GET.msg %}
        <div class="msg-box {% if 'æˆåŠŸ' in request.GET.msg %}msg-success{% else %}msg-error{% endif %}">
            {{ request.GET.msg }}
        </div>
    {% endif %}

    <div class="card">
        <table class="device-table">
            <thead>
                <tr>
                    <th>è®¾å¤‡åç§°</th>
                    <th>åºåˆ—å·</th>
                    <th>IP:ç«¯å£</th>
                    <th>è¿æ¥æ ‡è¯†</th>
                    <th>çŠ¶æ€</th>
                    <th>æ˜¯å¦å¯ç”¨</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for device in devices %}
                    <tr>
                        <td>{{ device.name }}</td>
                        <td class="serial-column">{{ device.serial|default:"-" }}</td>
                        <td>{{ device.ip|default:"-" }}:{{ device.port|default:"-" }}</td>
                        <td>{{ device.connect_id }}</td>
                        <td>
                            {% if device.status == 'online' %}
                                <span class="status-online">âœ… åœ¨çº¿</span>
                            {% elif device.status == 'error' %}
                                <span class="status-error">âš ï¸ å¼‚å¸¸</span>
                            {% else %}
                                <span class="status-offline">âŒ ç¦»çº¿</span>
                            {% endif %}
                        </td>
                        <td>{% if device.is_active %}âœ… æ˜¯{% else %}âŒ å¦{% endif %}</td>
                        <td>
                            <form method="POST" action="{% url 'adb_manager:connect' %}" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="device_id" value="{{ device.id }}">
                                <button type="submit" class="btn btn-success action-btn">è¿æ¥</button>
                            </form>
                            <form method="POST" action="{% url 'adb_manager:disconnect' %}" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="device_id" value="{{ device.id }}">
                                <button type="submit" class="btn btn-danger action-btn">æ–­å¼€</button>
                            </form>
                            <!-- æ–°å¢ï¼šè½¬æ¢æ— çº¿æŒ‰é’® -->
                            {% if device.status == 'online' %}
                            <form method="POST" action="{% url 'adb_manager:enable_wireless' %}" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="device_id" value="{{ device.id }}">
                                <button type="submit" class="btn btn-purple action-btn">è½¬æ¢æ— çº¿</button>
                            </form>
                            {% endif %}
                            <a href="{% url 'adb_manager:edit_device' device.id %}" class="btn btn-primary action-btn">ç¼–è¾‘</a>
                            <form method="POST" action="{% url 'adb_manager:delete_device' device.id %}" style="display: inline;" onsubmit="return confirm('ç¡®å®šåˆ é™¤è¯¥è®¾å¤‡å—ï¼Ÿ');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning action-btn">åˆ é™¤</button>
                            </form>
                            <!-- æ–°å¢ï¼šè®¾å¤‡è¯¦æƒ…æŒ‰é’® -->
                            <button class="btn btn-info action-btn view-detail-btn" data-device-id="{{ device.id }}">è¯¦æƒ…</button>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="7" class="empty-device-cell">
                            æš‚æ— è®¾å¤‡ï¼Œè¯·ç‚¹å‡»ã€Œæ·»åŠ è®¾å¤‡ã€æŒ‰é’®æ·»åŠ 
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- åŸæœ‰ï¼šå·²è¿æ¥è®¾å¤‡åˆ—è¡¨æ¨¡æ€æ¡†ï¼ˆä¿æŒä¸å˜ï¼‰ -->
    <div id="devicesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“± ADBå·²è¿æ¥è®¾å¤‡åˆ—è¡¨</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="modalBody">
                <div id="loading">åŠ è½½ä¸­...è¯·ç¨å€™</div>
                <div id="resultContainer" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šè®¾å¤‡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="deviceDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“± è®¾å¤‡è¯¦ç»†ä¿¡æ¯</h3>
                <button class="close-modal" id="closeDetailModal">&times;</button>
            </div>
            <div id="detailModalBody">
                <!-- åŠ è½½ä¸­æç¤º -->
                <div id="detailLoading">åŠ è½½ä¸­...è¯·ç¨å€™ï¼ˆéƒ¨åˆ†å‘½ä»¤æ‰§è¡Œå¯èƒ½éœ€è¦å‡ ç§’ï¼‰</div>
                <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
                <div id="detailResultContainer" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šæ“ä½œæ—¥å¿—æ¨¡æ€æ¡† -->
    <div id="logsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“œ è®¾å¤‡æ“ä½œæ—¥å¿—</h3>
                <button class="close-modal" id="closeLogsModal">&times;</button>
            </div>
            <div id="logsModalBody">
                <!-- ç­›é€‰åŒºåŸŸ -->
                <div class="logs-filter">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <div>
                            <label style="margin-right: 5px;">è®¾å¤‡ï¼š</label>
                            <select id="logDeviceFilter" class="form-control" style="padding: 4px; width: 180px;">
                                <option value="">æ‰€æœ‰è®¾å¤‡</option>
                                {% for device in devices %}
                                <option value="{{ device.id }}">{{ device.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label style="margin-right: 5px;">æ“ä½œç±»å‹ï¼š</label>
                            <select id="logTypeFilter" class="form-control" style="padding: 4px; width: 150px;">
                                <option value="">æ‰€æœ‰ç±»å‹</option>
                                <option value="connect">è¿æ¥è®¾å¤‡</option>
                                <option value="disconnect">æ–­å¼€è®¾å¤‡</option>
                                <option value="add">æ·»åŠ è®¾å¤‡</option>
                                <option value="edit">ç¼–è¾‘è®¾å¤‡</option>
                                <option value="delete">åˆ é™¤è®¾å¤‡</option>
                                <option value="enable_wireless">å¼€å¯æ— çº¿ADB</option>
                                <option value="connect_all">ä¸€é”®è¿æ¥æ‰€æœ‰</option>
                                <option value="disconnect_all">ä¸€é”®æ–­å¼€æ‰€æœ‰</option>
                                <option value="refresh_all">åˆ·æ–°æ‰€æœ‰çŠ¶æ€</option>
                            </select>
                        </div>
                        <div>
                            <label style="margin-right: 5px;">å¼€å§‹æ—¥æœŸï¼š</label>
                            <input type="date" id="logStartDate" class="form-control" style="padding: 4px; width: 120px;">
                        </div>
                        <div>
                            <label style="margin-right: 5px;">ç»“æŸæ—¥æœŸï¼š</label>
                            <input type="date" id="logEndDate" class="form-control" style="padding: 4px; width: 120px;">
                        </div>
                        <button id="logFilterBtn" class="btn btn-primary" style="padding: 4px 8px;">ç­›é€‰</button>
                        <button id="logResetBtn" class="btn btn-default" style="padding: 4px 8px; border: 1px solid #ccc;">é‡ç½®</button>
                    </div>
                </div>

                <!-- åŠ è½½ä¸­æç¤º -->
                <div id="logsLoading">åŠ è½½ä¸­...è¯·ç¨å€™</div>

                <!-- æ—¥å¿—åˆ—è¡¨åŒºåŸŸ -->
                <div id="logsResultContainer" style="display: none;">
                    <!-- æ—¥å¿—è¡¨æ ¼ -->
                    <table class="table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left; width: 5%;">#</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left; width: 15%;">æ“ä½œæ—¶é—´</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left; width: 10%;">æ“ä½œäºº</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left; width: 15%;">æ“ä½œè®¾å¤‡</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left; width: 15%;">æ“ä½œç±»å‹</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left; width: 8%;">æ“ä½œç»“æœ</th>
                                <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left; flex: 1;">æ“ä½œè¯¦æƒ…</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <!-- æ—¥å¿—æ•°æ®åŠ¨æ€æ¸²æŸ“ -->
                        </tbody>
                    </table>

                    <!-- åˆ†é¡µæ§ä»¶ -->
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>å…± <span id="logsTotalCount">0</span> æ¡è®°å½•ï¼Œå½“å‰ç¬¬ <span id="logsCurrentPage">1</span> é¡µ/å…± <span id="logsTotalPages">0</span> é¡µ</div>
                        <div>
                            <button id="logsPrevPage" class="btn btn-default" style="padding: 4px 8px; border: 1px solid #ccc; margin-right: 5px;" disabled>ä¸Šä¸€é¡µ</button>
                            <button id="logsNextPage" class="btn btn-default" style="padding: 4px 8px; border: 1px solid #ccc;" disabled>ä¸‹ä¸€é¡µ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// åŸæœ‰ï¼šå·²è¿æ¥è®¾å¤‡åˆ—è¡¨æ¨¡æ€æ¡†é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
const modal = document.getElementById("devicesModal");
const listDevicesBtn = document.getElementById("listDevicesBtn");
const closeModalBtn = document.querySelector(".close-modal");
const loading = document.getElementById("loading");
const resultContainer = document.getElementById("resultContainer");

listDevicesBtn.addEventListener("click", function() {
    modal.style.display = "flex";
    loading.style.display = "block";
    resultContainer.style.display = "none";

    fetch("{% url 'adb_manager:list_devices' %}", {
        method: "GET",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.style.display = "none";
        resultContainer.style.display = "block";

        if (data.code === 200) {
            const { device_count, connected_devices, raw_output, error } = data.data;
            let html = `
                <div class="alert alert-info">
                    å…±æ£€æµ‹åˆ° <strong>${device_count}</strong> å°å·²è¿æ¥è®¾å¤‡
                </div>
            `;

            if (device_count > 0) {
                html += "<h4>è®¾å¤‡è¯¦æƒ…ï¼š</h4>";
                connected_devices.forEach(device => {
                    html += `
                        <div class="device-list-item">
                            <span class="device-serial">${device.serial}</span> -
                            çŠ¶æ€ï¼š<span class="${device.status === 'device' ? 'status-online' : 'status-offline'}">${device.status}</span>
                            ${device.details ? `<br>è¯¦æƒ…ï¼š${device.details}` : ''}
                        </div>
                    `;
                });
            } else {
                html += "<div class='alert alert-warning'>æš‚æ— å·²è¿æ¥çš„ADBè®¾å¤‡</div>";
            }

            html += "<h4>åŸå§‹è¾“å‡ºï¼š</h4>";
            html += `<div class="raw-output">${raw_output || 'æ— '}</div>`;

            if (error) {
                html += `<div class="alert alert-danger" style="margin-top: 10px;">é”™è¯¯ä¿¡æ¯ï¼š${error}</div>`;
            }

            resultContainer.innerHTML = html;
        } else {
            resultContainer.innerHTML = `<div class="alert alert-danger">${data.msg}</div>`;
        }
    })
    .catch(error => {
        loading.style.display = "none";
        resultContainer.style.display = "block";
        resultContainer.innerHTML = `<div class="alert alert-danger">è¯·æ±‚å¤±è´¥ï¼š${error.message}</div>`;
    });
});

closeModalBtn.addEventListener("click", function() {
    modal.style.display = "none";
});

window.addEventListener("click", function(event) {
    if (event.target === modal) {
        modal.style.display = "none";
    }
});

// æ–°å¢ï¼šè®¾å¤‡è¯¦æƒ…æ¨¡æ€æ¡†é€»è¾‘
const detailModal = document.getElementById("deviceDetailModal");
const closeDetailModalBtn = document.getElementById("closeDetailModal");
const detailLoading = document.getElementById("detailLoading");
const detailResultContainer = document.getElementById("detailResultContainer");

// ç»‘å®šæ‰€æœ‰è¯¦æƒ…æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
document.querySelectorAll(".view-detail-btn").forEach(btn => {
    btn.addEventListener("click", function() {
        const deviceId = this.getAttribute("data-device-id");
        detailModal.style.display = "flex";
        detailLoading.style.display = "block";
        detailResultContainer.style.display = "none";

        // å‘é€è·å–è®¾å¤‡è¯¦æƒ…çš„è¯·æ±‚
        fetch(`{% url 'adb_manager:detail_device' %}?device_id=${deviceId}`, {
            method: "GET",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
        .then(data => {
            detailLoading.style.display = "none";
            detailResultContainer.style.display = "block";

            if (data.code === 200) {
                const d = data.data;
                let html = `
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="detail-section">
                        <div class="detail-section-title">åŸºæœ¬ä¿¡æ¯</div>
                        <div class="detail-item">
                            <div class="detail-label">è®¾å¤‡åç§°ï¼š</div>
                            <div class="detail-value">${d.device_name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">è¿æ¥æ ‡è¯†ï¼š</div>
                            <div class="detail-value">${d.connect_id}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">è®¾å¤‡åºåˆ—å·ï¼š</div>
                            <div class="detail-value">${d.serial}</div>
                        </div>
                    </div>

                    <!-- ç¡¬ä»¶ä¿¡æ¯ -->
                    <div class="detail-section">
                        <div class="detail-section-title">ç¡¬ä»¶ä¿¡æ¯</div>
                        <div class="detail-item">
                            <div class="detail-label">æ‰‹æœºå‚å•†ï¼š</div>
                            <div class="detail-value">${d.brand}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ‰‹æœºå‹å·ï¼š</div>
                            <div class="detail-value">${d.model}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ç³»ç»Ÿç‰ˆæœ¬ï¼š</div>
                            <div class="detail-value">Android ${d.system_version}</div>
                        </div>
                    </div>

                    <!-- ç”µæ± ä¿¡æ¯ -->
                    <div class="detail-section">
                        <div class="detail-section-title">ç”µæ± ä¿¡æ¯</div>
                        <div class="detail-item">
                            <div class="detail-label">å½“å‰ç”µé‡ï¼š</div>
                            <div class="detail-value">${d.battery_level}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ç”µæ± å¥åº·åº¦ï¼š</div>
                            <div class="detail-value">${d.battery_health}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ç”µæ± çŠ¶æ€ï¼š</div>
                            <div class="detail-value">${d.battery_status}</div>
                        </div>
                    </div>

                    <!-- ç½‘ç»œä¿¡æ¯ -->
                    <div class="detail-section">
                        <div class="detail-section-title">ç½‘ç»œä¿¡æ¯</div>
                        <div class="detail-item">
                            <div class="detail-label">WiFi IPåœ°å€ï¼š</div>
                            <div class="detail-value">${d.wifi_ip}</div>
                        </div>
                    </div>

                    <!-- è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ -->
                    <div class="detail-section">
                        <div class="detail-section-title">åŸå§‹å‘½ä»¤è¾“å‡ºï¼ˆè°ƒè¯•ç”¨ï¼‰</div>
                        <div class="raw-output" style="font-size: 12px;">
                            <pre>${JSON.stringify(d.raw_commands, null, 2)}</pre>
                        </div>
                    </div>
                `;
                detailResultContainer.innerHTML = html;
            } else {
                detailResultContainer.innerHTML = `<div class="alert alert-danger">${data.msg}</div>`;
            }
        })
        .catch(error => {
            detailLoading.style.display = "none";
            detailResultContainer.style.display = "block";
            detailResultContainer.innerHTML = `<div class="alert alert-danger">è¯·æ±‚å¤±è´¥ï¼š${error.message}</div>`;
        });
    });
});

// å…³é—­è®¾å¤‡è¯¦æƒ…æ¨¡æ€æ¡†
closeDetailModalBtn.addEventListener("click", function() {
    detailModal.style.display = "none";
});

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.addEventListener("click", function(event) {
    if (event.target === detailModal) {
        detailModal.style.display = "none";
    }
});

// æ–°å¢ï¼šæ“ä½œæ—¥å¿—æ¨¡æ€æ¡†é€»è¾‘
const logsModal = document.getElementById("logsModal");
const closeLogsModalBtn = document.getElementById("closeLogsModal");
const logsLoading = document.getElementById("logsLoading");
const logsResultContainer = document.getElementById("logsResultContainer");
const logsTableBody = document.getElementById("logsTableBody");
const logsTotalCount = document.getElementById("logsTotalCount");
const logsCurrentPage = document.getElementById("logsCurrentPage");
const logsTotalPages = document.getElementById("logsTotalPages");
const logsPrevPage = document.getElementById("logsPrevPage");
const logsNextPage = document.getElementById("logsNextPage");
const logDeviceFilter = document.getElementById("logDeviceFilter");
const logTypeFilter = document.getElementById("logTypeFilter");
const logStartDate = document.getElementById("logStartDate");
const logEndDate = document.getElementById("logEndDate");
const logFilterBtn = document.getElementById("logFilterBtn");
const logResetBtn = document.getElementById("logResetBtn");

// å½“å‰åˆ†é¡µå’Œç­›é€‰å‚æ•°
let currentLogPage = 1;
let currentLogFilters = {
    device_id: "",
    operation_type: "",
    start_date: "",
    end_date: ""
};

// åŠ è½½æ—¥å¿—æ•°æ®çš„æ ¸å¿ƒå‡½æ•°
function loadLogs(page = 1) {
    logsLoading.style.display = "block";
    logsResultContainer.style.display = "none";

    // æ„å»ºæŸ¥è¯¢å‚æ•°
    const params = new URLSearchParams();
    params.append("page", page);
    params.append("page_size", 20);
    if (currentLogFilters.device_id) params.append("device_id", currentLogFilters.device_id);
    if (currentLogFilters.operation_type) params.append("operation_type", currentLogFilters.operation_type);
    if (currentLogFilters.start_date) params.append("start_date", currentLogFilters.start_date);
    if (currentLogFilters.end_date) params.append("end_date", currentLogFilters.end_date);

    fetch(`{% url 'adb_manager:operation_logs' %}?${params.toString()}`, {
        method: "GET",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        }
    })
    .then(response => response.json())
    .then(data => {
        logsLoading.style.display = "none";
        logsResultContainer.style.display = "block";

        if (data.code === 200) {
            const { logs, total, page, total_pages } = data.data;
            currentLogPage = page;

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            logsTotalCount.textContent = total;
            logsCurrentPage.textContent = page;
            logsTotalPages.textContent = total_pages;

            // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
            logsPrevPage.disabled = page <= 1;
            logsNextPage.disabled = page >= total_pages;

            // æ¸²æŸ“æ—¥å¿—åˆ—è¡¨
            logsTableBody.innerHTML = "";
            if (logs.length === 0) {
                logsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 20px; text-align: center; border: 1px solid #dee2e6;">
                            æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—è®°å½•
                        </td>
                    </tr>
                `;
                return;
            }

            logs.forEach((log, index) => {
                const row = document.createElement("tr");
                row.style.borderBottom = "1px solid #eee";
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${(page-1)*20 + index + 1}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${log.created_at}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${log.username}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${log.device_name}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${log.operation_type_display}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        <span style="color: ${log.operation_result ? '#67c23a' : '#f56c6c'};">
                            ${log.operation_result_display}
                        </span>
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; word-break: break-all;">
                        ${log.operation_details || "æ— "}
                    </td>
                `;
                logsTableBody.appendChild(row);
            });
        } else {
            logsResultContainer.innerHTML = `<div class="alert alert-danger">${data.msg}</div>`;
        }
    })
    .catch(error => {
        logsLoading.style.display = "none";
        logsResultContainer.style.display = "block";
        logsResultContainer.innerHTML = `<div class="alert alert-danger">è¯·æ±‚å¤±è´¥ï¼š${error.message}</div>`;
    });
}

// ç»‘å®šæŸ¥çœ‹æ—¥å¿—æŒ‰é’®äº‹ä»¶
document.getElementById("viewLogsBtn").addEventListener("click", function() {
    logsModal.style.display = "flex";
    currentLogPage = 1; // é‡ç½®åˆ†é¡µ
    loadLogs(1);
});

// å…³é—­æ—¥å¿—æ¨¡æ€æ¡†
closeLogsModalBtn.addEventListener("click", function() {
    logsModal.style.display = "none";
});

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.addEventListener("click", function(event) {
    if (event.target === logsModal) {
        logsModal.style.display = "none";
    }
});

// ç­›é€‰æŒ‰é’®äº‹ä»¶
logFilterBtn.addEventListener("click", function() {
    currentLogFilters = {
        device_id: logDeviceFilter.value,
        operation_type: logTypeFilter.value,
        start_date: logStartDate.value,
        end_date: logEndDate.value
    };
    currentLogPage = 1;
    loadLogs(1);
});

// é‡ç½®ç­›é€‰æŒ‰é’®äº‹ä»¶
logResetBtn.addEventListener("click", function() {
    logDeviceFilter.value = "";
    logTypeFilter.value = "";
    logStartDate.value = "";
    logEndDate.value = "";
    currentLogFilters = {
        device_id: "",
        operation_type: "",
        start_date: "",
        end_date: ""
    };
    currentLogPage = 1;
    loadLogs(1);
});

// åˆ†é¡µæŒ‰é’®äº‹ä»¶
logsPrevPage.addEventListener("click", function() {
    if (currentLogPage > 1) {
        loadLogs(currentLogPage - 1);
    }
});

logsNextPage.addEventListener("click", function() {
    const totalPages = parseInt(logsTotalPages.textContent);
    if (currentLogPage < totalPages) {
        loadLogs(currentLogPage + 1);
    }
});
</script>
{% endblock %}