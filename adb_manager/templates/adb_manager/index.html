{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
    .status-online { color: #67c23a; font-weight: 500; }
    .status-offline { color: #f56c6c; }
    .status-error { color: #e6a23c; }
    .action-btn {
        padding: 4px 8px;
        font-size: 12px;
        margin-right: 5px;
    }
    .serial-column {
        max-width: 200px;
        word-break: break-all;
    }
    .device-table tr:hover {
        background-color: #f8f9fa;
    }
    .empty-device-cell {
        text-align: center;
        padding: 30px !important;
    }

    /* åŸæœ‰æ¨¡æ€æ¡†æ ·å¼ä¿æŒä¸å˜ */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background-color: #fff;
        width: 80%;
        max-width: 1000px;
        border-radius: 8px;
        padding: 20px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #1989fa;
    }
    .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
    }
    .close-modal:hover {
        color: #333;
    }
    .device-list-item {
        padding: 8px 0;
        border-bottom: 1px dashed #eee;
    }
    .device-list-item:last-child {
        border-bottom: none;
    }
    .device-serial {
        font-weight: 500;
        color: #1989fa;
    }
    .raw-output {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 14px;
        margin-top: 15px;
        white-space: pre-wrap;
    }

    /* æ–°å¢ï¼šè®¾å¤‡è¯¦æƒ…æ ·å¼ */
    .detail-item {
        display: flex;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px dashed #eee;
    }
    .detail-label {
        width: 120px;
        font-weight: 600;
        color: #666;
    }
    .detail-value {
        flex: 1;
        color: #333;
    }
    .detail-section {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
    .detail-section:last-child {
        border-bottom: none;
    }
    .detail-section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
        color: #1989fa;
    }
</style>
{% endblock %}

{% block page_header %}
<div class="page-header">
    <h1>ğŸ“± {{ page_title }}</h1>
    <div class="btn-group">
        <a href="{% url 'adb_manager:add_device' %}" class="btn btn-primary">æ·»åŠ è®¾å¤‡</a>
        <form method="POST" action="{% url 'adb_manager:connect_all' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">ä¸€é”®è¿æ¥æ‰€æœ‰</button>
        </form>
        <form method="POST" action="{% url 'adb_manager:disconnect_all' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">ä¸€é”®æ–­å¼€æ‰€æœ‰</button>
        </form>
        <form method="POST" action="{% url 'adb_manager:refresh_all' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-warning">åˆ·æ–°æ‰€æœ‰çŠ¶æ€</button>
        </form>
        <!-- åŸæœ‰ï¼šæŸ¥çœ‹å·²è¿æ¥è®¾å¤‡æŒ‰é’® -->
        <button id="listDevicesBtn" class="btn btn-info">æŸ¥çœ‹å·²è¿æ¥è®¾å¤‡</button>
    </div>
</div>
{% endblock %}

{% block content %}
    <!-- åŸæœ‰æç¤ºä¿¡æ¯ä¿æŒä¸å˜ -->
    {% if request.GET.msg %}
        <div class="msg-box {% if 'æˆåŠŸ' in request.GET.msg %}msg-success{% else %}msg-error{% endif %}">
            {{ request.GET.msg }}
        </div>
    {% endif %}

    <div class="card">
        <table class="device-table">
            <thead>
                <tr>
                    <th>è®¾å¤‡åç§°</th>
                    <th>åºåˆ—å·</th>
                    <th>IP:ç«¯å£</th>
                    <th>è¿æ¥æ ‡è¯†</th>
                    <th>çŠ¶æ€</th>
                    <th>æ˜¯å¦å¯ç”¨</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for device in devices %}
                    <tr>
                        <td>{{ device.name }}</td>
                        <td class="serial-column">{{ device.serial|default:"-" }}</td>
                        <td>{{ device.ip|default:"-" }}:{{ device.port|default:"-" }}</td>
                        <td>{{ device.connect_id }}</td>
                        <td>
                            {% if device.status == 'online' %}
                                <span class="status-online">âœ… åœ¨çº¿</span>
                            {% elif device.status == 'error' %}
                                <span class="status-error">âš ï¸ å¼‚å¸¸</span>
                            {% else %}
                                <span class="status-offline">âŒ ç¦»çº¿</span>
                            {% endif %}
                        </td>
                        <td>{% if device.is_active %}âœ… æ˜¯{% else %}âŒ å¦{% endif %}</td>
                        <td>
                            <form method="POST" action="{% url 'adb_manager:connect' %}" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="device_id" value="{{ device.id }}">
                                <button type="submit" class="btn btn-success action-btn">è¿æ¥</button>
                            </form>
                            <form method="POST" action="{% url 'adb_manager:disconnect' %}" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="device_id" value="{{ device.id }}">
                                <button type="submit" class="btn btn-danger action-btn">æ–­å¼€</button>
                            </form>
                            <a href="{% url 'adb_manager:edit_device' device.id %}" class="btn btn-primary action-btn">ç¼–è¾‘</a>
                            <form method="POST" action="{% url 'adb_manager:delete_device' device.id %}" style="display: inline;" onsubmit="return confirm('ç¡®å®šåˆ é™¤è¯¥è®¾å¤‡å—ï¼Ÿ');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning action-btn">åˆ é™¤</button>
                            </form>
                            <!-- æ–°å¢ï¼šè®¾å¤‡è¯¦æƒ…æŒ‰é’® -->
                            <button class="btn btn-info action-btn view-detail-btn" data-device-id="{{ device.id }}">è¯¦æƒ…</button>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="7" class="empty-device-cell">
                            æš‚æ— è®¾å¤‡ï¼Œè¯·ç‚¹å‡»ã€Œæ·»åŠ è®¾å¤‡ã€æŒ‰é’®æ·»åŠ 
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- åŸæœ‰ï¼šå·²è¿æ¥è®¾å¤‡åˆ—è¡¨æ¨¡æ€æ¡†ï¼ˆä¿æŒä¸å˜ï¼‰ -->
    <div id="devicesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“± ADBå·²è¿æ¥è®¾å¤‡åˆ—è¡¨</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="modalBody">
                <div id="loading">åŠ è½½ä¸­...è¯·ç¨å€™</div>
                <div id="resultContainer" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šè®¾å¤‡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="deviceDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“± è®¾å¤‡è¯¦ç»†ä¿¡æ¯</h3>
                <button class="close-modal" id="closeDetailModal">&times;</button>
            </div>
            <div id="detailModalBody">
                <!-- åŠ è½½ä¸­æç¤º -->
                <div id="detailLoading">åŠ è½½ä¸­...è¯·ç¨å€™ï¼ˆéƒ¨åˆ†å‘½ä»¤æ‰§è¡Œå¯èƒ½éœ€è¦å‡ ç§’ï¼‰</div>
                <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
                <div id="detailResultContainer" style="display: none;"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// åŸæœ‰ï¼šå·²è¿æ¥è®¾å¤‡åˆ—è¡¨æ¨¡æ€æ¡†é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
const modal = document.getElementById("devicesModal");
const listDevicesBtn = document.getElementById("listDevicesBtn");
const closeModalBtn = document.querySelector(".close-modal");
const loading = document.getElementById("loading");
const resultContainer = document.getElementById("resultContainer");

listDevicesBtn.addEventListener("click", function() {
    modal.style.display = "flex";
    loading.style.display = "block";
    resultContainer.style.display = "none";

    fetch("{% url 'adb_manager:list_devices' %}", {
        method: "GET",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.style.display = "none";
        resultContainer.style.display = "block";

        if (data.code === 200) {
            const { device_count, connected_devices, raw_output, error } = data.data;
            let html = `
                <div class="alert alert-info">
                    å…±æ£€æµ‹åˆ° <strong>${device_count}</strong> å°å·²è¿æ¥è®¾å¤‡
                </div>
            `;

            if (device_count > 0) {
                html += "<h4>è®¾å¤‡è¯¦æƒ…ï¼š</h4>";
                connected_devices.forEach(device => {
                    html += `
                        <div class="device-list-item">
                            <span class="device-serial">${device.serial}</span> -
                            çŠ¶æ€ï¼š<span class="${device.status === 'device' ? 'status-online' : 'status-offline'}">${device.status}</span>
                            ${device.details ? `<br>è¯¦æƒ…ï¼š${device.details}` : ''}
                        </div>
                    `;
                });
            } else {
                html += "<div class='alert alert-warning'>æš‚æ— å·²è¿æ¥çš„ADBè®¾å¤‡</div>";
            }

            html += "<h4>åŸå§‹è¾“å‡ºï¼š</h4>";
            html += `<div class="raw-output">${raw_output || 'æ— '}</div>`;

            if (error) {
                html += `<div class="alert alert-danger" style="margin-top: 10px;">é”™è¯¯ä¿¡æ¯ï¼š${error}</div>`;
            }

            resultContainer.innerHTML = html;
        } else {
            resultContainer.innerHTML = `<div class="alert alert-danger">${data.msg}</div>`;
        }
    })
    .catch(error => {
        loading.style.display = "none";
        resultContainer.style.display = "block";
        resultContainer.innerHTML = `<div class="alert alert-danger">è¯·æ±‚å¤±è´¥ï¼š${error.message}</div>`;
    });
});

closeModalBtn.addEventListener("click", function() {
    modal.style.display = "none";
});

window.addEventListener("click", function(event) {
    if (event.target === modal) {
        modal.style.display = "none";
    }
});

// æ–°å¢ï¼šè®¾å¤‡è¯¦æƒ…æ¨¡æ€æ¡†é€»è¾‘
const detailModal = document.getElementById("deviceDetailModal");
const closeDetailModalBtn = document.getElementById("closeDetailModal");
const detailLoading = document.getElementById("detailLoading");
const detailResultContainer = document.getElementById("detailResultContainer");

// ç»‘å®šæ‰€æœ‰è¯¦æƒ…æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
document.querySelectorAll(".view-detail-btn").forEach(btn => {
    btn.addEventListener("click", function() {
        const deviceId = this.getAttribute("data-device-id");
        detailModal.style.display = "flex";
        detailLoading.style.display = "block";
        detailResultContainer.style.display = "none";

        // å‘é€è·å–è®¾å¤‡è¯¦æƒ…çš„è¯·æ±‚
        fetch(`{% url 'adb_manager:detail_device' %}?device_id=${deviceId}`, {
            method: "GET",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
        .then(data => {
            detailLoading.style.display = "none";
            detailResultContainer.style.display = "block";

            if (data.code === 200) {
                const d = data.data;
                let html = `
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="detail-section">
                        <div class="detail-section-title">åŸºæœ¬ä¿¡æ¯</div>
                        <div class="detail-item">
                            <div class="detail-label">è®¾å¤‡åç§°ï¼š</div>
                            <div class="detail-value">${d.device_name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">è¿æ¥æ ‡è¯†ï¼š</div>
                            <div class="detail-value">${d.connect_id}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">è®¾å¤‡åºåˆ—å·ï¼š</div>
                            <div class="detail-value">${d.serial}</div>
                        </div>
                    </div>

                    <!-- ç¡¬ä»¶ä¿¡æ¯ -->
                    <div class="detail-section">
                        <div class="detail-section-title">ç¡¬ä»¶ä¿¡æ¯</div>
                        <div class="detail-item">
                            <div class="detail-label">æ‰‹æœºå‚å•†ï¼š</div>
                            <div class="detail-value">${d.brand}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ‰‹æœºå‹å·ï¼š</div>
                            <div class="detail-value">${d.model}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ç³»ç»Ÿç‰ˆæœ¬ï¼š</div>
                            <div class="detail-value">Android ${d.system_version}</div>
                        </div>
                    </div>

                    <!-- ç”µæ± ä¿¡æ¯ -->
                    <div class="detail-section">
                        <div class="detail-section-title">ç”µæ± ä¿¡æ¯</div>
                        <div class="detail-item">
                            <div class="detail-label">å½“å‰ç”µé‡ï¼š</div>
                            <div class="detail-value">${d.battery_level}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ç”µæ± å¥åº·åº¦ï¼š</div>
                            <div class="detail-value">${d.battery_health}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ç”µæ± çŠ¶æ€ï¼š</div>
                            <div class="detail-value">${d.battery_status}</div>
                        </div>
                    </div>

                    <!-- ç½‘ç»œä¿¡æ¯ -->
                    <div class="detail-section">
                        <div class="detail-section-title">ç½‘ç»œä¿¡æ¯</div>
                        <div class="detail-item">
                            <div class="detail-label">WiFi IPåœ°å€ï¼š</div>
                            <div class="detail-value">${d.wifi_ip}</div>
                        </div>
                    </div>

                    <!-- è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ -->
                    <div class="detail-section">
                        <div class="detail-section-title">åŸå§‹å‘½ä»¤è¾“å‡ºï¼ˆè°ƒè¯•ç”¨ï¼‰</div>
                        <div class="raw-output" style="font-size: 12px;">
                            <pre>${JSON.stringify(d.raw_commands, null, 2)}</pre>
                        </div>
                    </div>
                `;
                detailResultContainer.innerHTML = html;
            } else {
                detailResultContainer.innerHTML = `<div class="alert alert-danger">${data.msg}</div>`;
            }
        })
        .catch(error => {
            detailLoading.style.display = "none";
            detailResultContainer.style.display = "block";
            detailResultContainer.innerHTML = `<div class="alert alert-danger">è¯·æ±‚å¤±è´¥ï¼š${error.message}</div>`;
        });
    });
});

// å…³é—­è®¾å¤‡è¯¦æƒ…æ¨¡æ€æ¡†
closeDetailModalBtn.addEventListener("click", function() {
    detailModal.style.display = "none";
});

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.addEventListener("click", function(event) {
    if (event.target === detailModal) {
        detailModal.style.display = "none";
    }
});
</script>
{% endblock %}