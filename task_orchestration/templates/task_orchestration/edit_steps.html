<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{{ page_title }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
    <style>
        .card {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-control {
            width: auto;
            display: inline-block;
        }
        .error-msg {
            color: #f56c6c;
            margin: 10px 0;
        }
        .success-msg {
            color: #67c23a;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>{{ page_title }}</h2>

        <!-- 提示信息 -->
        {% if request.GET.msg %}
            <div class="success-msg">{{ request.GET.msg }}</div>
        {% endif %}
        {% if error_msg %}
            <div class="error-msg">{{ error_msg }}</div>
        {% endif %}

        <!-- 任务基本信息编辑 -->
        <div class="card">
            <h3>任务基本信息</h3>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_task">
                {{ task_form.as_p }}
                <button type="submit" class="btn btn-primary">保存任务信息</button>
            </form>
        </div>

        <!-- 子任务步骤管理 -->
        <div class="card">
            <h3>子任务步骤（按顺序执行）</h3>
            <!-- 添加步骤表单 -->
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_step">
                {{ step_form.as_p }}
                <button type="submit" class="btn btn-primary">添加步骤</button>
            </form>

            <!-- 步骤列表 -->
            <table class="table mt-4">
                <thead>
                    <tr>
                        <th>执行顺序</th>
                        <th>关联脚本任务</th>
                        <th>运行时长(秒)</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for step in steps %}
                    <tr>
                        <td>{{ step.execution_order }}</td>
                        <td>{{ step.script_task.task_name }}</td>
                        <td>
                            <!-- 显示模式 -->
                            <span class="run-duration-display-{{ step.id }}">{{ step.run_duration }}</span>

                            <!-- 编辑模式（默认隐藏） -->
                            <form method="post" class="run-duration-edit-{{ step.id }}" style="display: none; margin: 0;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="edit_step">
                                <input type="hidden" name="step_id" value="{{ step.id }}">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <!-- 直接遍历edit_forms，匹配当前step.id -->
                                    {% for form_id, form in edit_forms.items %}
                                        {% if form_id == step.id %}
                                            {{ form.run_duration }}
                                            {% if form.run_duration.errors %}
                                                {% for error in form.run_duration.errors %}
                                                    <span style="color: #f56c6c; font-size: 12px;">{{ error }}</span>
                                                {% endfor %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    <button type="submit" class="btn btn-sm btn-primary">保存</button>
                                    <button type="button" class="btn btn-sm btn-default" onclick="cancelEdit({{ step.id }})">取消</button>
                                </div>
                            </form>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary" onclick="editDuration({{ step.id }})">编辑</button>
                            <a href="{% url 'task_orchestration:delete_step' step.id %}" class="btn btn-sm btn-danger" onclick="return confirm('确定删除该步骤吗？')">删除</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center">暂无步骤，请添加</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 返回列表 -->
        <a href="{% url 'task_orchestration:list' %}" class="btn btn-default">返回任务列表</a>
    </div>

    <!-- 编辑功能JS -->
    <script>
        // 显示编辑表单，隐藏显示值
        function editDuration(stepId) {
            document.querySelector(`.run-duration-display-${stepId}`).style.display = 'none';
            document.querySelector(`.run-duration-edit-${stepId}`).style.display = 'block';
        }

        // 取消编辑，显示值，隐藏编辑表单
        function cancelEdit(stepId) {
            document.querySelector(`.run-duration-display-${stepId}`).style.display = 'block';
            document.querySelector(`.run-duration-edit-${stepId}`).style.display = 'none';
        }
    </script>
</body>
</html>