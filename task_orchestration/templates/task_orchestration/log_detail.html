{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            padding: 20px;
            background-color: #f5f7fa;
            font-family: "Microsoft YaHei", monospace;
            font-size: 14px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header h1 {
            color: #303133;
            font-size: 24px;
            font-weight: 600;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            margin: 0 4px;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #409eff;
            color: #fff;
        }
        .btn-default {
            background-color: #f5f7fa;
            color: #606266;
            border: 1px solid #e4e7ed;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e4e7ed;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        .info-item {
            display: flex;
            flex-direction: column;
        }
        .info-item label {
            color: #909399;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .info-item span {
            color: #303133;
            font-size: 14px;
            font-weight: 500;
            word-break: break-all;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-running { background-color: #e8f4fd; color: #409eff; }
        .status-completed { background-color: #f0f9eb; color: #67c23a; }
        .status-part_failed { background-color: #fef0f0; color: #e6a23c; }
        .status-failed { background-color: #fef0f0; color: #f56c6c; }
        .status-stopped { background-color: #f5f5f5; color: #909399; }
        .status-timeout { background-color: #fdf6ec; color: #e6a23c; }
        .status-error { background-color: #fef0f0; color: #f56c6c; }

        .log-content {
            margin-top: 16px;
            border: 1px solid #e4e7ed;
            border-radius: 4px;
            overflow: hidden;
        }
        .log-tab {
            display: flex;
            background-color: #f5f7fa;
            border-bottom: 1px solid #e4e7ed;
        }
        .log-tab-item {
            padding: 8px 16px;
            cursor: pointer;
            border-right: 1px solid #e4e7ed;
            font-weight: 500;
            color: #606266;
        }
        .log-tab-item.active {
            background-color: #fff;
            color: #409eff;
        }
        .log-tab-content {
            padding: 16px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: Consolas, monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #303133;
        }
        .log-tab-content.error {
            color: #f56c6c;
        }

        .step-card {
            border: 1px solid #e4e7ed;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .step-header {
            background-color: #f8f9fa;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e4e7ed;
        }
        .step-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .step-order {
            font-size: 16px;
            font-weight: 600;
            color: #409eff;
        }
        .step-name {
            font-size: 15px;
            font-weight: 500;
            color: #303133;
        }
        .step-body {
            padding: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ page_title }}</h1>
        <div>
            <a href="{% url 'task_orchestration:execute_orchestration' %}" class="btn btn-default">ğŸ”™ è¿”å›æ‰§è¡Œé¡µé¢</a>
            <a href="{% url 'task_orchestration:list' %}" class="btn btn-primary">ğŸ“‹ ç¼–æ’ä»»åŠ¡åˆ—è¡¨</a>
        </div>
    </div>

    <!-- ç¼–æ’æ—¥å¿—åŸºæœ¬ä¿¡æ¯ -->
    <div class="card">
        <div class="card-title">åŸºæœ¬ä¿¡æ¯</div>
        <div class="info-grid">
            <div class="info-item">
                <label>ç¼–æ’ä»»åŠ¡åç§°</label>
                <span>{{ orch_log.orchestration.name }}</span>
            </div>
            <div class="info-item">
                <label>æ‰§è¡Œè®¾å¤‡</label>
                <span>{{ orch_log.device.device_name }} ({{ orch_log.device.adb_connect_str }})</span>
            </div>
            <div class="info-item">
                <label>æ‰§è¡ŒçŠ¶æ€</label>
                <span class="status-badge status-{{ orch_log.exec_status }}">
                    {{ orch_log.get_exec_status_display }}
                </span>
            </div>
            <div class="info-item">
                <label>å¼€å§‹æ—¶é—´</label>
                <span>{{ orch_log.start_time|date:"Y-m-d H:i:s" }}</span>
            </div>
            <div class="info-item">
                <label>ç»“æŸæ—¶é—´</label>
                <span>{{ orch_log.end_time|date:"Y-m-d H:i:s"|default:"æ‰§è¡Œä¸­" }}</span>
            </div>
            <div class="info-item">
                <label>æ€»è€—æ—¶</label>
                <span>{{ orch_log.exec_duration_str }}</span>
            </div>
            <div class="info-item">
                <label>æ‰§è¡Œè¿›åº¦</label>
                <span>{{ orch_log.completed_steps }}/{{ orch_log.total_steps }} æ­¥éª¤</span>
            </div>
        </div>

        <!-- å…¨å±€æ‰§è¡Œå‘½ä»¤ -->
        <div class="info-item" style="margin-top: 16px;">
            <label>æ‰§è¡Œå‘½ä»¤ï¼ˆå…¨å±€ï¼‰</label>
            <div class="log-content" style="height: auto; max-height: 100px;">
                <div class="log-tab-content">{{ orch_log.exec_command|default:"æ— " }}</div>
            </div>
        </div>

        <!-- å…¨å±€è¾“å‡º -->
        <div class="log-content" style="margin-top: 16px;">
            <div class="log-tab">
                <div class="log-tab-item active" onclick="switchTab('stdout')">æ ‡å‡†è¾“å‡º</div>
                <div class="log-tab-item" onclick="switchTab('stderr')">é”™è¯¯è¾“å‡º</div>
            </div>
            <div id="stdout" class="log-tab-content">{{ orch_log.stdout|default:"æ— " }}</div>
            <div id="stderr" class="log-tab-content error" style="display: none;">{{ orch_log.stderr|default:"æ— " }}</div>
        </div>

        {% if orch_log.error_msg %}
        <div class="info-item" style="margin-top: 16px;">
            <label>å…¨å±€é”™è¯¯ä¿¡æ¯</label>
            <span style="color: #f56c6c; font-weight: normal;">{{ orch_log.error_msg }}</span>
        </div>
        {% endif %}
    </div>

    <!-- æ­¥éª¤æ‰§è¡Œè¯¦æƒ… -->
    <div class="card">
        <div class="card-title">æ­¥éª¤æ‰§è¡Œè¯¦æƒ…</div>
        {% for step_log in step_logs %}
        <div class="step-card">
            <div class="step-header">
                <div class="step-header-left">
                    <div class="step-order">æ­¥éª¤ {{ step_log.step.execution_order }}</div>
                    <div class="step-name">{{ step_log.step.script_task.task_name }}</div>
                </div>
                <span class="status-badge status-{{ step_log.exec_status }}">
                    {{ step_log.get_exec_status_display }}
                </span>
            </div>
            <div class="step-body">
                <div class="info-grid" style="margin-bottom: 12px;">
                    <div class="info-item">
                        <label>å¼€å§‹æ—¶é—´</label>
                        <span>{{ step_log.start_time|date:"Y-m-d H:i:s" }}</span>
                    </div>
                    <div class="info-item">
                        <label>ç»“æŸæ—¶é—´</label>
                        <span>{{ step_log.end_time|date:"Y-m-d H:i:s"|default:"æ‰§è¡Œä¸­" }}</span>
                    </div>
                    <div class="info-item">
                        <label>è€—æ—¶</label>
                        <span>{{ step_log.exec_duration|default:0|floatformat:2 }} ç§’</span>
                    </div>
                    <div class="info-item">
                        <label>è¿”å›ç </label>
                        <span>{{ step_log.return_code|default:"æ— " }}</span>
                    </div>
                </div>

                <!-- æ­¥éª¤æ‰§è¡Œå‘½ä»¤ -->
                <div class="info-item" style="margin-bottom: 12px;">
                    <label>æ‰§è¡Œå‘½ä»¤</label>
                    <div class="log-content" style="height: auto; max-height: 80px;">
                        <div class="log-tab-content">{{ step_log.exec_command|default:"æ— " }}</div>
                    </div>
                </div>

                <!-- æ­¥éª¤è¾“å‡º -->
                <div class="log-content">
                    <div class="log-tab">
                        <div class="log-tab-item active" onclick="switchStepTab('step{{ step_log.id }}-stdout', this)">æ ‡å‡†è¾“å‡º</div>
                        <div class="log-tab-item" onclick="switchStepTab('step{{ step_log.id }}-stderr', this)">é”™è¯¯è¾“å‡º</div>
                    </div>
                    <div id="step{{ step_log.id }}-stdout" class="log-tab-content">{{ step_log.stdout|default:"æ— " }}</div>
                    <div id="step{{ step_log.id }}-stderr" class="log-tab-content error" style="display: none;">{{ step_log.stderr|default:"æ— " }}</div>
                </div>

                {% if step_log.error_msg %}
                <div class="info-item" style="margin-top: 12px;">
                    <label>æ­¥éª¤é”™è¯¯ä¿¡æ¯</label>
                    <span style="color: #f56c6c; font-weight: normal;">{{ step_log.error_msg }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div style="text-align: center; padding: 20px; color: #909399;">
            æš‚æ— æ­¥éª¤æ‰§è¡Œæ—¥å¿—
        </div>
        {% endfor %}
    </div>

    <script>
        // å…¨å±€æ ‡ç­¾åˆ‡æ¢ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
        function switchTab(tabId) {
            document.querySelectorAll('.log-tab-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.log-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            event.target.classList.add('active');
            document.getElementById(tabId).style.display = 'block';
        }

        // æ­¥éª¤æ ‡ç­¾åˆ‡æ¢ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
        function switchStepTab(tabId, el) {
            const parent = el.closest('.log-tab');
            parent.querySelectorAll('.log-tab-item').forEach(item => {
                item.classList.remove('active');
            });
            parent.nextElementSibling.querySelectorAll('.log-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            el.classList.add('active');
            document.getElementById(tabId).style.display = 'block';
        }

        // è½®è¯¢åˆ·æ–°ç¼–æ’æ—¥å¿—ï¼ˆå…œåº•å‡½æ•°ï¼‰
function startOrchestrationPolling(logId) {
    const pollInterval = setInterval(() => {
        fetch(`{% url 'task_orchestration:log_status' 0 %}`.replace('0', logId))
            .then(response => {
                if (!response.ok) throw new Error('è½®è¯¢æ¥å£å¼‚å¸¸');
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    // æ›´æ–°å…¨å±€æ—¥å¿—
                    document.getElementById('stdout').textContent = data.stdout || 'æ— ';
                    document.getElementById('stderr').textContent = data.stderr || 'æ— ';
                    // æ›´æ–°æ­¥éª¤æ—¥å¿—ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šç”¨step_log_idåŒ¹é…å…ƒç´ IDï¼‰
                    data.step_data.forEach(step => {
                        const stdoutEl = document.getElementById(`step${step.step_log_id}-stdout`);
                        const stderrEl = document.getElementById(`step${step.step_log_id}-stderr`);
                        if (stdoutEl) stdoutEl.textContent = step.stdout || 'æ— ';
                        if (stderrEl) stderrEl.textContent = step.stderr || 'æ— ';
                    });
                    // ä»»åŠ¡ç»“æŸååœæ­¢è½®è¯¢
                    if (data.status !== "running") {
                        clearInterval(pollInterval);
                        location.reload();
                    }
                }
            })
            .catch(err => {
                console.warn('ç¼–æ’æ—¥å¿—è½®è¯¢å¤±è´¥:', err);
            });
    }, 2000);
    return pollInterval;
}

// WebSocket + è½®è¯¢é™çº§ä¸»é€»è¾‘
document.addEventListener('DOMContentLoaded', function() {
    const logId = "{{ orch_log.id }}";
    const status = "{{ orch_log.exec_status }}";

    if (status === "running") {
        let pollInterval = null; // è½®è¯¢å®šæ—¶å™¨

        // ä¼˜å…ˆå°è¯• WebSocket è¿æ¥
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/orchestration_log/${logId}/`;
        const socket = new WebSocket(wsUrl);

        // WebSocket è¿æ¥æˆåŠŸï¼šç¦ç”¨è½®è¯¢
        socket.onopen = function(e) {
            console.log(`[ç¼–æ’æ—¥å¿—-${logId}] WebSocketè¿æ¥å·²å»ºç«‹`);
            if (pollInterval) clearInterval(pollInterval);
        };

        // WebSocket æ¥æ”¶æ¶ˆæ¯ï¼šå®æ—¶æ›´æ–°æ—¥å¿—ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šç”¨step_log_idåŒ¹é…ï¼‰
        socket.onmessage = function(e) {
            const response = JSON.parse(e.data);
            if (response.type === 'log_update') {
                const data = response.data;
                document.getElementById('stdout').textContent = data.stdout || 'æ— ';
                document.getElementById('stderr').textContent = data.stderr || 'æ— ';
                if (data.step_data && Array.isArray(data.step_data)) {
                    data.step_data.forEach(step => {
                        const stdoutEl = document.getElementById(`step${step.step_log_id}-stdout`);
                        const stderrEl = document.getElementById(`step${step.step_log_id}-stderr`);
                        if (stdoutEl) stdoutEl.textContent = step.stdout || 'æ— ';
                        if (stderrEl) stderrEl.textContent = step.stderr || 'æ— ';
                    });
                }
                if (data.status !== "running") {
                    socket.close();
                    setTimeout(() => location.reload(), 1000);
                }
            }
        };

        // WebSocket å¤±è´¥/å…³é—­ï¼šå¯åŠ¨è½®è¯¢é™çº§
        socket.onerror = function(error) {
            console.error(`[ç¼–æ’æ—¥å¿—-${logId}] WebSocketè¿æ¥å¤±è´¥ï¼Œå¯åŠ¨è½®è¯¢é™çº§`, error);
            if (!pollInterval) pollInterval = startOrchestrationPolling(logId);
        };
        socket.onclose = function(e) {
            if (status === "running" && e.code !== 1000) {
                console.warn(`[ç¼–æ’æ—¥å¿—-${logId}] WebSocketè¿æ¥å…³é—­ï¼Œå¯åŠ¨è½®è¯¢é™çº§`, e.code);
                if (!pollInterval) pollInterval = startOrchestrationPolling(logId);
            }
        };

        // åˆå§‹å¯åŠ¨è½®è¯¢ï¼ˆWebSocket è¿æ¥æˆåŠŸåä¼šè‡ªåŠ¨åœæ­¢ï¼‰
        pollInterval = startOrchestrationPolling(logId);
    }
});
    </script>
</body>
</html>